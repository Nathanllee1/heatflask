<!DOCTYPE html>
<html>
<head>
    <title>Activities Visualization</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- JQuery UI Theme  -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.css') }}">

    <!-- Bootstrap Icons -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet">


    <!-- Leaflet stuff -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet-sidebar.css') }}"/>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/L.Control.ZoomBox.css') }}" />


    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            color: #AAA;
        }
    </style>


    <!-- JQuery -->
    <script src="{{ url_for('static', filename='js/jquery-3.1.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>

    <!-- Leaflet.js -->
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>

    <!-- sidebar v2 -->
    <script src="{{ url_for('static', filename='js/leaflet-sidebar.js') }}"></script>

    <!-- Spinner to display during time-intensive operations -->
    <script src="{{ url_for('static', filename='js/leaflet.spin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>

    <!-- Moment.js for current date-->
    <script src="{{ url_for('static', filename='js/moment.js') }}"></script>

    <!-- Heatmap -->
    <script src="{{ url_for('static', filename='js/leaflet-heat.js') }}"></script>

    <!-- ant (Flow) path -->
    <script src="{{ url_for('static', filename='js/leaflet-ant-path.js') }}"></script>

    <!-- Zoom control -->
    <script src="{{ url_for('static', filename='js/L.Control.ZoomBox.min.js') }}"></script>


</head>
<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                <a href="#home" role="tab"><i class="fa fa-bars"></i></a>
                </li>

                {% if current_user.is_authenticated
                    and (current_user.name == username) %}
                <li>
                {% else %}
                <li class="disabled">
                {% endif %}
                <a href="#profile" role="tab"><i class="fa fa-user"></i></a>
                </li>

                <li><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>

            <ul role="tablist">
                <li>
                <a href="#settings" role="tab"><i class="fa fa-gear"></i></a>
                </li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    {{ username }}'s map
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h3>Enter dates over which to render:</h3>

                  <form id="renderform" action="{{ url_for('index', username=username)}}">

                     <span style="display:block">
                      <label for="preset" style="display:block">Relative-Date Preset:</label>
                      <select id ="preset" form="renderform" >
                        <option value=2 selected="selected">Last 2 days</option>
                        <option value=7>Last 7 days</option>
                        <option value=30>Last 30 days</option>
                        <option value=60>Last 60 days</option>
                        <option value=180>Last 180 days</option>
                        <option value=365>Last year</option>
                        <option value=-7 disabled>This week (M-F)</option>
                        <option value=-30 disabled>This month</option>
                        <option value=-365 disabled>This year</option>
                        <option value=0 disabled>All</option>
                        <option value="">----</option>
                      </select>
                      </span>

                      <br>

                      <span style="display:block">
                        <label for="date1" style="display:block">Start Date:</label>
                        <input class="datepick" id="date1" type="text"  value=""/>
                      </span>
                      <br>

                      <span style="display:block">
                        <label for="date2" style="display:block">End Date:</label>
                        <input class="datepick" id="date2" type="text" value=""/>
                      </span>

                      <br>

                      <span style="display:block">
                      <label for="renderHeat" style="display:block">Heat Layer:</label>
                      <select id="heatres" name="renderHeat" form="renderform">
                        <option value="">None</option>
                        <option value="high" selected="selected">High resolution</option>
                        <option value="low">Low resolution</option>
                      </select>
                      </span>


                        <span style="display:block">
                      <label for="renderFlow" style="display:block">Flow Layer:</label>
                      <select id="flowres" name="renderFlow" form="renderform">
                        <option value="">None</option>
                        <option value="high">High resolution</option>
                        <option value="low" selected="selected">Low resolution</option>
                      </select>
                      </span>


                        <div class="checkbox">
                          <label><input type="checkbox" id="autozoom" value="1">Auto-Zoom on render</label>
                        </div>

                    <br>
                    <button type="button" id="renderButton" class="btn btn-primary">Render Layers</button><br>


                  </form>
                  <br>

                <div id="numlatlngs"></div>

                <hr>
                {% if current_user.is_authenticated %}
                <h3>Logged in as {{ current_user.name }}</h3>
                    <form action={{ url_for('logout') }}>
                        <input type="submit" class="btn btn-danger" value="Log Out" />
                    </form>
                {% else %}
                    Create an account and/or
                    <br><br>
                    <a href="{{ url_for('authorize', service='strava') }}">
                    <img src="static/LogInWithStrava.png">
                    </a>
                    <br><br>
                    Note: Our copy of your GIS data is publicly viewable.  You can delete your account with us along with all of the data at any time.
                {% endif %}


                <div>

                </div>

            </div>

            {% if current_user.is_authenticated
                    and (current_user.name == username) %}
            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header">{{ username }}<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


                <h3> {{ current_user.strava_user_data['firstname'] }}
                     {{ current_user.strava_user_data['lastname'] }}:</h3>
                <a href="https://www.strava.com/settings/profile" target="_blank">
                    <img src={{ current_user.strava_user_data['pic_url'] }} alt="user image" height="30%" width="30%">
                </a>

                <br>

                <h3>Import activities now:</h3>
                <form id="importform" method="get" action="{{ url_for('activity_import')}}" target="output">
                    <h4>
                    Import

                    <input type="number" name="count" value=10 min=0 max=10>
                    most recent activities from
                    <select name='service'>
                        <option selected="selected" value="strava">Strava</option>
                        <option disabled value="gc">Garmin Connect</option>
                    </select>
                    <br>
                    <input type="checkbox" checked name="detailed" value="yes">Import High-Resolution data<br>
                    <br>
                    <input type="submit" value="Go!"/>
                    </h4>
                    <br>
                    <div class="embed-responsive embed-responsive-4by3">
                      <iframe class="embed-responsive-item" name="output" style="width:100%"></iframe>
                    </div>
                </form>

                <br>
                <hr>
                <br><br>
                <form action={{ url_for('delete', username=username) }}>
                    <input type="submit" class="btn btn-danger" value="Delete Account" />
                </form>
            </div>
            {% endif %}


            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

                <h3>Latest News:</h3>
                <br>
                <h4>2016-08-08</h4>
                This app is in heavy development.  Bugs and features will come and go for a while so enjoy experimenting with it.
                <br><br>
                Feel free to <a href="mailto:Rensi.Efrem@gmail.com?Subject=About heatmapp" target="_top">contact me via email</a> with suggestions.
                <br><br>
                Better yet,
                <a href="https://github.com/ebrensi/heatmappp/blob/master/CONTRIBUTING.md">join in the project!</a>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Map Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


            </div>
         </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <a href="https://github.com/ebrensi/running_data" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>



    <script>
        var osmMap = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        });

        var EsriMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        var map = L.map('map',
                        {center: [{{ lat }}, {{ lng }}],
                         zoom: {{ zoom }},
                         layers : [ EsriMap ]
                  });


        var sidebar = L.control.sidebar('sidebar').addTo(map);

        var baseLayers = {
            "Open Street Map": osmMap,
            "Esri World Imagery": EsriMap
        };

        var control = L.control.layers(baseLayers, null, {position: 'topleft'}).addTo(map);

        var zoom_control = L.control.zoomBox({
            modal: true,
        });
        map.addControl(zoom_control);

        var latlngs;
        var HeatLayer = false;
        var FlowLayer = false;

        var heatLayerOptions = {{ config["HEATMAP_DEFAULT_OPTIONS"]|tojson|safe}};

        function renderHeatLayer(vis){
            var d1 = $("#date1").val();
            var d2 = $("#date2").val();

            var query_data = {start: d1, end: d2, resolution: $("#heatres:checked").val()}

            map.spin(true);   // start progress indicator
            $.getJSON('/{{ username }}/latlngs/flat', query_data, function(latlngs) {
                //latlngs is the JSON object
                if (latlngs.length) {
                    if (HeatLayer){
                    map.removeLayer(HeatLayer);
                    control.removeLayer(HeatLayer);
                }
                HeatLayer = L.heatLayer(latlngs, heatLayerOptions);
                map.addLayer(HeatLayer);
                var title = "Point Density: ("+d1+" - "+d2+")";
                control.addOverlay(HeatLayer, title);
                if ($("#autozoom:checked").val()) {
                    map.fitBounds(latlngs);
                }

            };
        }).always(function() {
            map.spin(false); // stop progress indicator
            });
      };



        flowLayerOptions = {{ config["ANTPATH_DEFAULT_OPTIONS"]|tojson|safe }};

        function renderFlowLayer(){
            var d1 = document.getElementById("date1").value;
            var d2 = document.getElementById("date2").value;

            var query_data = {start: d1, end: d2, resolution: $("#flowres:checked").val()}

            map.spin(true);   // start progress indicator
            $.getJSON('/{{ username }}/latlngs/list', query_data, function(latlngs) {
            //latlngs is the JSON object
            if (latlngs.length) {
                if (FlowLayer){
                    map.removeLayer(FlowLayer);
                    control.removeLayer(FlowLayer);
                }
                FlowLayer = new L.MultiPolyline.MultiAntPath(latlngs, flowLayerOptions);
                map.addLayer(FlowLayer);
                var title = "Ant Paths: ("+d1+" - "+d2+")"
                control.addOverlay(FlowLayer, title);

                if ($("#autozoom:checked").val()) {
                    map.fitBounds(latlngs);
                }
            };
        }).always(function() {
            map.spin(false); // stop progress indicator
            });
      };


        function renderLayers(){
            if ($("#heatres").val()) {
                renderHeatLayer();
            } else if (HeatLayer){
                map.removeLayer(HeatLayer);
            }

            if ($("#flowres").val()) {
                renderFlowLayer();
            } else if (FlowLayer) {
                map.removeLayer(FlowLayer);
            }

            updateURL();
        }

        function updateURL(){
            var params = {};

            if ($("#preset").val()) {
                params.preset = $("#preset").val();
            } else {
                params.date1 = $('#date1').val();
                params.date2 = $('#date2').val();
            }

            if($("#autozoom").is(':checked')) {
                params.autozoom = "1";
            } else {
                var zoom = map.getZoom();
                    center = map.getCenter(),
                    precision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));
                params.lat = center.lat.toFixed(precision);
                params.lng = center.lng.toFixed(precision);
                params.zoom = zoom;
            }

            if ($("#heatres").val())
                params.heatres = $("#heatres").val();

            if ($("#flowres").val())
                params.flowres = $("#flowres").val();


            var newURL = "{{ username }}" + "?" + jQuery.param(params);
            window.history.pushState("", "", newURL);
        }


        function preset_date_fill() {
            var F = "YYYY-MM-DD";
            var choice = $("#preset").val();

            // date1 defaults to
            var date1 = moment("20090215", "YYYYMMDD");
            if (choice){
                date1=moment().subtract(choice, 'days');
            };

            $('#date1').val(date1.format(F));


            // end date defaults to tomorrow, so that default query includes
            //  today's events.
            var date2 = moment().add(1, 'days');
            $('#date2').val(date2.format(F));
        };



        $(document).ready(function() {

            $(".datepick").datepicker({ dateFormat: 'yy-mm-dd',
                                        changeMonth: true,
                                        changeYear: true
                                    });
            map.on('moveend', function(e) {
                updateURL();
            });

            $("#autozoom").on("change",updateURL);

            $(".datepick").on("change", function(){$("#preset").val("");})
            $("#preset").on("change", preset_date_fill);

            $("#renderButton").on('click', renderLayers);

            $("#heatres").val("{{ heatres }}")
            $("#flowres").val("{{ flowres }}")

            {% if autozoom  %}
            $("#autozoom").prop('checked', true);
            {% endif %}

            {% if preset %}
            $("#preset").val("{{ preset }}");
            preset_date_fill();
            {% else %}
            $('#date1').val("{{ date1 }}");
            $('#date2').val("{{ date2 }}");
            $("#preset").val("");
            {% endif %}

            renderLayers();
        })


      </script>

</body>
</html>
