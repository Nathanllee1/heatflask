<!DOCTYPE html>
<html>
<head>
    <title>{{ config["APP_NAME"] }}</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    {% assets "index_css" %}
    <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}


    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            color: #AAA;
        }
    </style>

    {% assets "index_js" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}

    {% if not current_user.strava_id in config["ADMIN"] %}
    {{analytics}}
    {% endif %}

</head>
<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                <a href="#home" role="tab"><i class="fa fa-bars"></i></a>
                </li>

                {% if current_user.is_authenticated
                    and (current_user.username == username) %}
                <li>
                {% else %}
                <li class="disabled">
                {% endif %}
                <a href="#profile" role="tab"><i class="fa fa-user"></i></a>
                </li>

                <li><a href="#messages" role="tab"><i class="fa fa-sticky-note-o"></i></a></li>
            </ul>

            <ul role="tablist">
                <li class="disabled">
                <a href="#settings" role="tab"><i class="fa fa-gear"></i></a>
                </li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    <a href="https://www.strava.com/athletes/{{ username }}" target="_blank"><img src="{{ url_for('static',filename='strava_button.png')}}" width=20, height=20 class="img-fluid"> </a>
                    {{ username }}'s map
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h3>Enter dates over which to render:</h3>

                <form id="renderform" action="{{ url_for('index', username=username)}}">

                 <span style="display:block">
                  <label for="preset" style="display:block">Relative-Date Preset:</label>
                  <select id ="preset" form="renderform" >
                    <option value=2 selected="selected">Last 2 days</option>
                    <option value=7>Last 7 days</option>
                    <option value=30>Last 30 days</option>
                    <option value=60>Last 60 days</option>
                    <option value=180>Last 180 days</option>
                    <option value=365>Last year</option>
                    <option value=-7 disabled>This week (M-F)</option>
                    <option value=-30 disabled>This month</option>
                    <option value=-365 disabled>This year</option>
                    <option value=0 disabled>All</option>
                    <option value="">----</option>
                  </select>
                  </span>

                  <br>

                  <span style="display:block">
                    <label for="date1" style="display:block">Start Date:</label>
                    <input class="datepick" id="date1" type="text"  value=""/>
                  </span>
                  <br>

                  <span style="display:block">
                    <label for="date2" style="display:block">End Date:</label>
                    <input class="datepick" id="date2" type="text" value=""/>
                  </span>
                  <br>

                  <span style="display:block">
                  <label for="renderHeat" style="display:block">Heat Layer:</label>
                  <select id="heatres" name="renderHeat" form="renderform">
                    <option value="">None</option>
                    <option value="high">High resolution</option>
                    <option value="low">Low resolution</option>
                  </select>
                  </span>


                    <span style="display:block">
                  <label for="renderFlow" style="display:block">Flow Layer:</label>
                  <select id="flowres" name="renderFlow" form="renderform">
                    <option value="">None</option>
                    <option value="high">High resolution</option>
                    <option value="low">Low resolution</option>
                  </select>
                  </span>


                    <div class="checkbox">
                      <label><input type="checkbox" id="autozoom" value="1">Auto-Zoom on render</label>
                    </div>

                <hr>
                    <div id="data_message">
                        {% with messages = get_flashed_messages() %}
                            {% if messages %}
                              <ul class=flashes>
                              {% for message in messages %}
                                <li>{{ message }}</li>
                              {% endfor %}
                              </ul>
                            {% endif %}
                        {% endwith %}
                    </div>
                <hr>

                <button type="button" id="renderButton" class="btn btn-primary">Render Layers</button>

              </form>
                <br>

                <hr>
                {% if current_user.is_authenticated %}
                You are logged in as <a href="{{ url_for('index', username=current_user.username) }}">{{ current_user.username }}</a> :<br>
                <form action="{{ url_for('logout') }}">
                    <input type="submit" class="btn btn-danger" value="Log Out" />

                    <input class="current-url" type="hidden" id="afterLogout" name="next" value="" />
                </form>
                {% else %}

                Create an account and/or log in
                <br>

                <form action="{{ url_for('authorize') }}" >
                    <input type="image" src="{{ url_for('static', filename='btn_strava_connectwith_orange.svg') }}" alt="Log-In with Strava" >
                    <input class="current-url" type="hidden" name="state" value="" >
                </form>


                {% endif %}


                <div>

                </div>

            </div>

            {% if current_user.is_authenticated
                    and (current_user.username == username) %}
            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header"> <a href="https://www.strava.com/athletes/{{ username }}" target="_blank"><img src="{{ url_for('static',filename='strava_button.png')}}" width=20, height=20 class="img-fluid"> </a>  {{ username }} ({{ current_user.strava_id }}) <span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


                <h3> {{ current_user.firstname }}
                     {{ current_user.lastname }}:</h3>

                <a href="https://www.strava.com/settings/profile" target="_blank">
                    <img src={{ current_user.profile }} alt="user image" height="30%" width="30%">
                </a>

                <br>


                <h3>Manage activity cache:</h3>
                <img src="{{ url_for('static', filename='under-construction.gif') }}" height=50><br>
                 <form action="{{ url_for('activities_sse') }}" target="_blank">

                    List
                    <input type="number" name="limit" value=10 min=0 max=100>
                    most recent Strava activities.
                    <br>
                    <input type="submit" value="Go!"/>
                </form>


                <h3>Cache activities now:</h3>
                <form id="importform" method="get" action="{{ url_for('activity_import', username=username)}}" target="output">

                    Import High-resolution data for

                    <input type="number" name="count" value=10 min=0 max=50>
                    most recent activities from Strava.
                    <br>
                    <input type="submit" value="Go!"/>

                    <br>
                    <!-- <div class="embed-responsive embed-responsive-4by3">
                      <iframe class="embed-responsive-item" name="output" style="width:100% height=20"></iframe>
                    </div> -->

                    <iframe name="output" style="width:100% height=5"></iframe>
                </form>





                <br>
                <form action="{{ url_for('logout') }}">
                    <input type="submit" class="btn btn-danger" value="Log Out" />

                    <input class="current-url" type="hidden" id="afterLogout" name="next" value="" />
                </form>

                <br>
                <hr>
                <br><br>
                <form action="{{ url_for('delete') }}" onsubmit="return confirm('Delete your info from our database?');">
                    <input type="submit" class="btn btn-danger" value="Delete Account" />
                </form>
            </div>
            {% endif %}


            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Info<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <br>
                {{ config['APP_NAME'] }} is a work in progress.<br>
                <br><br>
                How we access data:  Low-resolution data is retrieved directly from Strava and we don't cache it in this app's database.  Hi-Resolution data takes longer to import so the current version of this app automatically imports GIS points for activities the first time they are requested and caches them in a database.  On subsequent requests for an activity's (Hi-res) data, the app will check the database first and get it from there if it is available.  Right now there is no limit on the number of activities that get cached, but since we are using a cheap database that stores a maximum of 10000 activities, we will periodically clear it. At any time you can delete your accout with us, which will clear our cache for you and delete your Strava access token from our database.  The token we obtain is for public data, so this app won't import any activities you have set to private.  The URL for a heat/flow map and the current location dates or preset, zoom, and map, are embedded in the url so you can share that url and anyone who clicks on it will get the same view.
                <br><br>
                2016-10-21:  Back-end upgrade. The database was cleared.
                <br><br>
                Questions or comments, suggestions, job offers?<br>
                <a href="mailto:Rensi.Efrem@gmail.com?Subject=About {{ config['APP_NAME'] }}">Contact Me.</a>
                <br><br>
                Check out the <a href="https://github.com/ebrensi/heatmappp" target="_blank">GitHub repo</a>.  Pull requests welcome!

                <br><br>
                Note: You can specify a custom map baselayer by setting "baselayer={map}" in the URL, where {map} is one of the provider names from
                 <a href="https://leaflet-extras.github.io/leaflet-providers/preview" target="_blank">leaflet-providers</a>
                <hr>

            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Map Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


            </div>
         </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <a href="https://github.com/ebrensi/running_data" class="github-corner" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>



    <script>
        var map_providers = {{ baselayer|tojson|safe }};

        var default_baseLayer;
        var baseLayers = {
            "None": L.tileLayer(""),
            "Esri.WorldImagery": L.tileLayer.provider("Esri.WorldImagery")
        };

        var online = ("{{ config['OFFLINE'] }}" != "True");

        if (map_providers.length && online) {

            for (var i = 0; i < map_providers.length; i++) {
                provider = map_providers[i];
                var tl = L.tileLayer.provider(provider);
                baseLayers[provider] = tl;
                if (i==0)
                    default_baseLayer = tl;
            }
        } else
            default_baseLayer = baseLayers["None"];

        var map = L.map('map',
                        {center: [{{ lat }}, {{ lng }}],
                         zoom: {{ zoom }},
                         layers : [ default_baseLayer ]
                  });


        var control = L.control.layers(baseLayers, null, {position: 'topleft'}).addTo(map);


        var sidebar = L.control.sidebar('sidebar').addTo(map);

        var HeatLayer = false;
        var FlowLayer = false;
        var FooLayer = false;

        // This is where we store current state of the app
        var appState = {
            baseLayers: map_providers
        };

        var heatLayerOptions = {{ config["HEATMAP_DEFAULT_OPTIONS"]|tojson|safe }};
        var flowLayerOptions = {{ config["ANTPATH_DEFAULT_OPTIONS"]|tojson|safe }};

        function renderLayers(){
            var heat_data = false,
                flow_data = false,
                durations = false;

            var flowres = $("#flowres").val(),
                heatres = $("#heatres").val(),
                date1 = $("#date1").val(),
                date2 = $("#date2").val();

            dates_changed = ((date1 != appState.date1) || (date2 != appState.date2));

            var query = {
                start: $("#date1").val(),
                end: $("#date2").val(),
                hires: flowres == "high" || heatres == "high",
                lores: flowres == "low" || heatres == "low",
                durations: flowres == "high"
            };

            map.spin(true);   // start progress indicator
            $.getJSON('/{{ username }}/getdata', query, function(data) {

                // if ("error" in data){
                //     $("#data_message").html("<font color='red'>" + data.error +"</font>");
                //     return;
                // }

                $("#data_message").html("");

                // console.log(data);
                var latlngs_flat = [],
                    count = 0;

                // Remove HeatLayer from map and control if it's there
                if (HeatLayer){
                    map.removeLayer(HeatLayer);
                    control.removeLayer(HeatLayer);
                    HeatLayer = false;
                }

                // Remove FlowLayer from map and control if it's there
                if (FlowLayer){
                    map.removeLayer(FlowLayer);
                    control.removeLayer(FlowLayer);
                    FlowLayer = false;
                }

                // Add new blank HeatLayer to map if specified
                if (heatres){
                    HeatLayer = L.heatLayer(latlngs_flat, heatLayerOptions);
                    map.addLayer(HeatLayer);
                    control.addOverlay(HeatLayer, "Point Density");
                }

                // Add new blank FlowLayer to map if specified
                if (flowres){
                    FlowLayer = new L.layerGroup();
                    map.addLayer(FlowLayer);
                    control.addOverlay(FlowLayer, "Flow Paths");
                }

                var bounds = L.latLngBounds();

                for (var i = 0; i < data.length; i++) {
                    var A = data[i];
                    var extend_bounds = true;

                    if ("error" in A){
                        $("#data_message").html("<font color='red'>" + A.error +"</font>");
                    } else {
                        msg = "rendering [" + A.id + "] " + A.name;
                        $("#data_message").html(msg);
                    }

                    if (flowres){
                        // add this activity's route to FlowLayer
                        var options = {{ config["ANTPATH_DEFAULT_OPTIONS"]|tojson|safe }};
                        if (("path_color" in A) && A.path_color)
                            options.color = A.path_color;
                    }

                    if (query.lores && ("summary_polyline" in A)) {
                        var latlngs = L.PolylineUtil.decode(A.summary_polyline);
                        if (extend_bounds){
                            bounds.extend(latlngs);
                            extend_bounds = false;
                        }

                        if (heatres == "low")
                            latlngs_flat.push.apply(latlngs_flat, latlngs);
                        if (flowres == "low")
                            FlowLayer.addLayer(new L.Polyline.AntPath(latlngs, options));
                    }


                    if (query.hires && ("polyline" in A)){
                        var latlngs = L.PolylineUtil.decode(A.polyline);
                        if (extend_bounds)
                            bounds.extend(latlngs);

                        if (heatres == "high")
                            latlngs_flat.push.apply(latlngs_flat, latlngs);
                        if (flowres == "high")
                            FlowLayer.addLayer(new L.Polyline.AntPath(latlngs, options));
                    }
                }


                if ($("#autozoom:checked").val() && bounds.isValid())
                    map.fitBounds(bounds);

                msg = i + " activities rendered." ;
                $("#data_message").html(msg);


            }).always(function() {
                    map.spin(false); // stop progress indicator

                    appState['date1'] = date1;
                    appState["date2"] = date2;
                    appState["flowres"] = flowres;
                    appState["heatres"] = heatres;

                    updateURL();
                });
        }


        function updateURL(){
            var params = {};

            if ($("#preset").val()) {
                params.preset = $("#preset").val();
            } else {
                params.date1 = appState.date1;
                params.date2 = appState.date2;
            }

            if($("#autozoom").is(':checked')) {
                params.autozoom = "1";
            } else {
                var zoom = map.getZoom();
                    center = map.getCenter(),
                    precision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));
                params.lat = center.lat.toFixed(precision);
                params.lng = center.lng.toFixed(precision);
                params.zoom = zoom;
            }

            if ($("#heatres").val())
                params.heatres = $("#heatres").val();

            if ($("#flowres").val())
                params.flowres = $("#flowres").val();

            params["baselayer"] = appState.baseLayers;

            var newURL = "{{ username }}" + "?" + jQuery.param(params, true);
            window.history.pushState("", "", newURL);

            $(".current-url").val(newURL);
        }


        function preset_date_fill() {
            var F = "YYYY-MM-DD";
            var choice = $("#preset").val();

            // date1 defaults to
            var date1 = moment("20090215", "YYYYMMDD");
            if (choice){
                date1=moment().subtract(choice, 'days');
            };

            $('#date1').val(date1.format(F));


            // end date defaults to tomorrow, so that default query includes
            //  today's events.
            var date2 = moment().add(1, 'days');
            $('#date2').val(date2.format(F));
        };



        $(document).ready(function() {

            $(".datepick").datepicker({ dateFormat: 'yy-mm-dd',
                                        changeMonth: true,
                                        changeYear: true
                                    });
            map.on('moveend', function(e) {
                updateURL();
            });

            $("#autozoom").on("change",updateURL);

            $(".datepick").on("change", function(){$("#preset").val("");})
            $("#preset").on("change", preset_date_fill);

            $("#renderButton").on('click', renderLayers);

            $("#heatres").val("{{ heatres }}")
            $("#flowres").val("{{ flowres }}")

            {% if autozoom  %}
            $("#autozoom").prop('checked', true);
            {% endif %}

            {% if preset %}
            $("#preset").val("{{ preset }}");
            preset_date_fill();
            {% else %}
            $('#date1').val("{{ date1 }}");
            $('#date2').val("{{ date2 }}");
            $("#preset").val("");
            {% endif %}

            renderLayers();
        })


      </script>

</body>
</html>
