<!DOCTYPE html>
<html>
<head>
    <title>{{ config["APP_NAME"] }}</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    {% assets "index_css" %}
    <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}


    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            color: #AAA;
        }
    </style>

    {% assets "index_js" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLvYWwPmLsBRCGXeMHh-InA9rq35jdVeA" async defer></script>

    {% if not current_user.strava_id in config["ADMIN"] %}
    {{analytics}}
    {% endif %}

</head>
<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                <a href="#home" role="tab"><i class="fa fa-bars"></i></a>
                </li>

                {% if current_user.is_authenticated
                    and (current_user.strava_id == user.strava_id) %}
                <li>
                {% else %}
                <li class="disabled">
                {% endif %}
                <a href="#profile" role="tab"><i class="fa fa-user"></i></a>
                </li>

                <li><a href="#messages" role="tab"><i class="fa fa-sticky-note-o"></i></a></li>
            </ul>

            <ul role="tablist">
                <li class="disabled">
                <a href="#settings" role="tab"><i class="fa fa-gear"></i></a>
                </li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    <a href="https://www.strava.com/athletes/{{ user.strava_id }}" target="_blank"><img src="{{ url_for('static',filename='strava_button.png')}}" width=20, height=20 class="img-fluid"> </a>
                    {{ user.username or user.strava_id }}'s map
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h3>Activities query:</h3>

                <br>
                <form id="renderform" action="{{ url_for('index', username=user.strava_id)}}">

                 <span id="num_select">
                  <input class="preset" id="select_num" type="number" value=0 min=0 max=500>
                  most</span>

                 <span>
                  <select class="preset" id="select_type" form="renderform">
                    <option value="days">recent days</option>
                    <option value="activities">recent activities</option>
                    <option value="" selected="selected">Date-Range</option>
                  </select>
                  </span>
                  <br>
                  <br>


                  <span class="select_date" style="display:block">
                    After
                    <input class="datepick" id="date1" type="text"  value=""/>
                  </span>
                  <br>

                  <span class="select_date" style="display:block">
                    Before
                    <input class="datepick" id="date2" type="text" value=""/>
                  </span>
                  <hr>

                  <span style="display:block">
                  <label for="renderHeat" style="display:block">Heat Layer:</label>
                  <select id="heatres" name="renderHeat" form="renderform">
                    <option value="">None</option>
                    <option value="high">High resolution</option>
                    <option value="low">Low resolution</option>
                  </select>
                  </span>


                    <span style="display:block">
                  <label for="renderFlow" style="display:block">Flow Layer:</label>
                  <select id="flowres" name="renderFlow" form="renderform">
                    <option value="">None</option>
                    <option value="high">High resolution</option>
                    <option value="low">Low resolution</option>
                  </select>
                  </span>


                    <div class="checkbox">
                      <label><input type="checkbox" id="autozoom" value="1">Auto-Zoom on render</label>
                    </div>

                <hr>
                    <div id="data_message">
                    </div>
                <hr>

                <button type="button" id="renderButton" class="btn btn-primary">Render Layers</button>
                <button type="button" id="abortButton" class="btn btn-danger">Abort</button>

              </form>
                <br>

                <hr>
                {% if current_user.is_authenticated %}
                You are logged in as <a href="{{ url_for('index', username=current_user.strava_id) }}" target="_blank">{{ current_user.username or current_user.strava_id}}</a> :<br>

                <form action="{{ url_for('logout') }}">
                    <input type="submit" class="btn btn-danger" value="Log Out" />

                    <input class="current-url" type="hidden" id="afterLogout" name="next" value="" />
                </form>
                {% else %}

                Create an account and/or log in
                <br>

                <form action="{{ url_for('authorize') }}" >
                    <input type="image" src="{{ url_for('static', filename='btn_strava_connectwith_orange.svg') }}" alt="Log-In with Strava" >
                    <input class="current-url" type="hidden" name="state" value="" >
                </form>


                {% endif %}


                <div>

                </div>

            </div>

            {% if current_user.is_authenticated
                    and (current_user.strava_id == user.strava_id) %}
            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header"> <a href="https://www.strava.com/athletes/{{ user.strava_id }}" target="_blank"><img src="{{ url_for('static',filename='strava_button.png')}}" width=20, height=20 class="img-fluid"> </a>  {{ current_user.username or current_user.strava_id }} <span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


                <h3> {{ current_user.firstname }}
                     {{ current_user.lastname }}:</h3>

                <a href="https://www.strava.com/settings/profile" target="_blank">
                    <img src={{ current_user.profile }} alt="user image" height="30%" width="30%">
                </a>

                <br><br>
                <form action="{{ url_for('activities') }}" target="_blank">
                    <input type="submit" class="btn" value="List" />
                    <input type="number" name="limit" min="1" max="10000" value="100" />
                    most recent activities
                </form>
                <br>

                <hr>




                <br>
                <form action="{{ url_for('logout') }}">
                    <input type="submit" class="btn btn-danger" value="Log Out" />

                    <input class="current-url" type="hidden" id="afterLogout" name="next" value="" />
                </form>

                <br>
                <hr>
                <br><br>
                <form action="{{ url_for('delete') }}" onsubmit="return confirm('Delete your info from our database?');">
                    <input type="submit" class="btn btn-danger" value="Delete Account" />
                </form>
            </div>
            {% endif %}


            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Info<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <br>
                {{ config['APP_NAME'] }} is a work in progress.
                <img src="{{ url_for('static', filename='under-construction.gif') }}" height=40>
                <br><br>
                How we access data: When redering activities, low-resolution data is retrieved directly from Strava and is cached in-memory for 5 minutes.  High-Resolution data is fast-cached for 1 hour, and kept in our database for 7 days.   If high-resolution data for an activity is not accessed for over 7 days then it gets deleted from our database.
                <br>
                On subsequent requests for an activity's (Hi-res) data, Heatflask will check the memory-cache first, then the database, and finally import from Strava.
                <br><br>
                The token we obtain is for public data, so Heatflask will not import or render any activities you have set to private.
                Deleting your accout with us clears our database cache for you and deletes your Strava access token from our database.

                <br><br>
                The URL for a heat/flow map and the current location dates or preset, zoom, and map, are embedded in the url so you can share that url and anyone who clicks on it will get the same view.
                <br><br>

                Questions, comments, suggestions?<br>
                <a href="mailto:Rensi.Efrem@gmail.com?Subject=About {{ config['APP_NAME'] }}">Contact Me.</a>

                <br><br>
                Note: You can specify a custom map baselayer by setting "baselayer={map}" in the URL, where {map} is one of the provider names from
                 <a href="https://leaflet-extras.github.io/leaflet-providers/preview" target="_blank">leaflet-providers</a>
                <hr>

            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Map Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>


            </div>
         </div>
    </div>

    <div id="map" class="sidebar-map"></div>


    <script>
        var map_providers = {{ baselayer|tojson|safe }};

        var default_baseLayer;
        var baseLayers = {
            "None": L.tileLayer(""),
            "Esri.WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
            // valid Google types are 'roadmap', 'satellite', 'terrain' and 'hybrid'
            "Google.Roadmap":  L.gridLayer.googleMutant({type: 'roadmap'}),
            "Google.Terrain":  L.gridLayer.googleMutant({type: 'terrain'}),
            "Google.Hybrid": L.gridLayer.googleMutant({type: 'hybrid'})
        };


        var offline = ("{{ config['OFFLINE'] }}" == "True");

        if (offline) {
            default_baseLayer = baseLayers["None"];
        } else if (map_providers.length) {
            for (var i = 0; i < map_providers.length; i++) {
                provider = map_providers[i];
                var tl = L.tileLayer.provider(provider);
                baseLayers[provider] = tl;
                if (i==0)
                    default_baseLayer = tl;
            }
        } else {
            default_baseLayer = baseLayers["Google.Roadmap"];
        }

        var map = L.map('map',
                        {center: [{{ lat }}, {{ lng }}],
                         zoom: {{ zoom }},
                         layers : [ default_baseLayer ]
                  });


        var control = L.control.layers(baseLayers, null, {position: 'topleft'}).addTo(map);

         {% with messages = get_flashed_messages() %}
            {% if messages %}
              var msg = "<ul class=flashes>"

              {% for message in messages %}
                msg += "<li>{{ message }}</li>"
              {% endfor %}
              msg += "</ul>"
              var winMtds = L.control.window(map, {content:msg, visible:true});
            {% endif %}
        {% endwith %}


        var zoomControl = map.zoomControl.setPosition('bottomright');

        var sidebar = L.control.sidebar('sidebar').addTo(map);

        var HeatLayer = false;
        var FlowLayer = false;
        var FooLayer = false;

        // This is where we store current state of the app
        var appState = {
            baseLayers: map_providers
        };

        var heatLayerOptions = {{ config["HEATMAP_DEFAULT_OPTIONS"]|tojson|safe }};
        var flowLayerOptions = {{ config["ANTPATH_DEFAULT_OPTIONS"]|tojson|safe }};

        function renderLayers(){
            var flowres = $("#flowres").val(),
                heatres = $("#heatres").val(),
                date1 = $("#date1").val(),
                date2 = $("#date2").val(),
                type = $("#select_type").val(),
                num = $("#select_num").val();

            var heat_data = false,
                flow_data = false,
                durations = false;

            var lores = (flowres == "low" || heatres == "low"),
                hires = (flowres == "high" || heatres == "high"),
                query = {};

            if (type=="activities") {
                if (num == 0) {
                    query.limit = 1;
                }
                else
                    query.limit = num;
            }

            if (date1) query.date1 = date1;
            if (date2 && (date2 != "now")) query.date2 = date2;
            if (hires) query.hires = hires;


            $("#data_message").html("");
            appState.items = [];

            var latlngs_flat = [];

            // Remove HeatLayer from map and control if it's there
            if (HeatLayer){
                map.removeLayer(HeatLayer);
                control.removeLayer(HeatLayer);
                HeatLayer = false;
            }

            // Remove FlowLayer from map and control if it's there
            if (FlowLayer){
                map.removeLayer(FlowLayer);
                control.removeLayer(FlowLayer);
                FlowLayer = false;
            }

            // Add new blank HeatLayer to map if specified
            if (heatres){
                HeatLayer = L.heatLayer(latlngs_flat, heatLayerOptions);
                map.addLayer(HeatLayer);
                control.addOverlay(HeatLayer, "Point Density");
            }

            // Add new blank FlowLayer to map if specified
            if (flowres){
                FlowLayer = new L.layerGroup();
                map.addLayer(FlowLayer);
                control.addOverlay(FlowLayer, "Flow Paths");
            }

            var bounds = L.latLngBounds();

            var base_url = "{{ url_for('getdata', username=user.strava_id) }}";
            var url = base_url + "?" + jQuery.param(query, true);

            map.spin(true);   // start progress indicator

            var source = new EventSource(url);
            $("#abortButton").show();

            var abort = false;

            function done(msg){
                source.close();
                map.spin(false); // stop progress indicator
                $("#abortButton").hide();

                if ($("#autozoom:checked").val() && bounds.isValid())
                    map.fitBounds(bounds);

                msg2 = msg + " " + appState.items.length + " activities rendered.";
                $("#data_message").html(msg2);
            }

            $('#abortButton').click(function(){
                done("<font color='red'>Aborted:</font>");
            });

            $("#data_message").html("Connecting to Strava...");

            source.onmessage = function(event) {

            if (event.data != 'done'){
                var A = JSON.parse(event.data);
                var extend_bounds = true;

                if ("error" in A){
                    msg = "<font color='red'>" + A.error +"</font>";
                    var winMtds = L.control.window(map, {title: "Oops.", content:msg, visible:true});
                    source.close();
                    map.spin(false);
                    $("#abortButton").hide();

                } else if ("msg" in A) {
                    $("#data_message").html(A.msg);
                    return;
                } else {
                    msg = "rendering [" + A.id + "] " + A.name;
                    $("#data_message").html(msg);
                }

                if (flowres){
                    // add this activity's route to FlowLayer
                    var options = {{ config["ANTPATH_DEFAULT_OPTIONS"]|tojson|safe }};

                    if (("path_color" in A) && A.path_color)
                        options.color = A.path_color;
                }

                if (lores && ("summary_polyline" in A) && (A.summary_polyline)) {
                    var latlngs = L.PolylineUtil.decode(A.summary_polyline);
                    if (extend_bounds){
                        bounds.extend(latlngs);
                        extend_bounds = false;
                    }

                    if (heatres == "low")
                        latlngs_flat.push.apply(latlngs_flat, latlngs);
                    if (flowres == "low")
                        FlowLayer.addLayer(new L.Polyline.AntPath(latlngs, options));
                }


                if (query.hires && ("polyline" in A) && (A.polyline)){
                    var latlngs = L.PolylineUtil.decode(A.polyline);
                    if (extend_bounds) {
                        bounds.extend(latlngs);
                        extend_bounds = false;
                    }
                    if (heatres == "high")
                        latlngs_flat.push.apply(latlngs_flat, latlngs);
                    if (flowres == "high")
                        FlowLayer.addLayer(new L.Polyline.AntPath(latlngs, options));
                }

                if (!extend_bounds) {
                    delete A.summary_polyline;
                    delete A.polyline;
                    delete A.time;
                    appState.items.push(A);
                }

              } else {
                done("Finished. ");
                appState['date1'] = date1;
                appState["date2"] = date2;
                appState["limit"] = limit;
                appState["flowres"] = flowres;
                appState["heatres"] = heatres;
                updateURL();
              }
            }
        }


        function updateURL(){
            var params = {},
                type = $("#select_type").val(),
                num = $("#select_num").val();

            if (type == "activities") params.limit = num;
            else if (type == "days") params.preset = num;
            else {
                if (appState.date1) params.date1 = appState.date1;
                if (appState.date2 && (appState.date2 != "now")) params.date2 = appState.date2;
            }

            if($("#autozoom").is(':checked')) {
                params.autozoom = "1";
            } else {
                var zoom = map.getZoom();
                    center = map.getCenter(),
                    precision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));
                params.lat = center.lat.toFixed(precision);
                params.lng = center.lng.toFixed(precision);
                params.zoom = zoom;
            }

            if ($("#heatres").val())
                params.heatres = $("#heatres").val();

            if ($("#flowres").val())
                params.flowres = $("#flowres").val();

            params["baselayer"] = appState.baseLayers;

            var newURL = "{{ user.username or user.strava_id }}" + "?" + jQuery.param(params, true);
            window.history.pushState("", "", newURL);

            $(".current-url").val(newURL);
        }


        function preset_sync() {
            var F = "YYYY-MM-DD",
                num = $("#select_num").val(),
                type = $("#select_type").val();

            $('#query_type').text(type);
            if (type=="days"){
                $(".select_date").hide()
                $("#num_select").show()
                $('#date1').val(moment().subtract(num, 'days').format(F));
                $('#date2').val("now");
            } else if (type=="activities"){
                $(".select_date").hide()
                $("#num_select").show()
                $('#date1').val("");
                $('#date2').val("now")
            }
            else {
                $(".select_date").show()
                $("#select_num").val("")
                $("#num_select").hide()
            }

        };



        $(document).ready(function() {
            $("#abortButton").hide()

            $(".datepick").datepicker({ dateFormat: 'yy-mm-dd',
                                        changeMonth: true,
                                        changeYear: true
                                    });
            map.on('moveend', function(e) {
                updateURL();
            });

            $("#autozoom").on("change",updateURL);

            $(".datepick").on("change", function(){
                $(".preset").val("");
            });
            $(".preset").on("change", preset_sync);

            $("#renderButton").on('click', renderLayers);

            $("#heatres").val("{{ heatres }}")
            $("#flowres").val("{{ flowres }}")

            {% if autozoom  %}
            $("#autozoom").prop('checked', true);
            {% endif %}

            {% if limit %}
            $("#select_num").val("{{ limit }}");
            $("#select_type").val("activities");
            {% elif preset %}
            $("#select_num").val("{{ preset }}");
            $("#select_type").val("days");
            preset_sync();
            {% else %}
            $('#date1').val("{{ date1 }}");
            $('#date2').val("{{ date2 }}");
            $("#preset").val("");
            {% endif %}

            renderLayers();
            preset_sync();

        })


      </script>

</body>
</html>
