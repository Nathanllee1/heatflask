<!DOCTYPE html>
<html>
  <head>
    <title>Activities List</title>
    <style>
      #data {
        text-align: center;
      }
    </style>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/jquery-3.1.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
  </head>

  <body>
  <h2>Activities list</h2>
  <div class="table-responsive">
  <table id='activities_list' class='display order-column' cellspacing='0' width='100%'></table>
  </div>


  <div id="status"></div>

  <script>
    let atable = $('#activities_list').DataTable({
            paging: false,
            scrollY: "70vh",
            scrollX: true,
            scrollCollapse: true,
            order: [[ 1, "desc" ]],
            select: true,
            columns: [
                { data: "ID", title: "ID" },
                { data: "date", title: "Date"},
                { data: "type", title: "Type"},
                { data: "dist", title: "Dist"},
                { data: "time", title: "Time"},
                { data: "name", title: "Name"},
                { data: "strava_link", title: "Strava"},
                { data: "heatflask_link", title: "Heatflask"}

            ]
        });

    function hhmmss(secs) {
        return new Date(secs * 1000).toISOString().substr(11, 8);
    }

    function href(url, text){
        return `<a href='${url}' target='_blank'>${text}</a>`
    }

    function stravaActivityURL(id) {
        return `https://www.strava.com/activities/${id}`;
    }


    jQuery(document).ready(function($) {
        let source = new EventSource("{{ url_for('activity_stream', username=user.id, limit=limit) }}"),
            count = 0,
            USER_BASE_URL = "{{url_for('main',username=user.id)}}";
        $("#status").text("Getting Activity List");

        source.onmessage = function(event) {
          if (event.data == 'done') {
            source.close();
            $("#status").text("Listing " + count + " activities");
          } else {
            let A = JSON.parse(event.data),
                strava_link = href(stravaActivityURL(A.id), A.id),
                heatflask_link = href(`?id=${A.id}`, A.id),
                ts = A.beginTimestamp.slice(0,10),
                dkm = +(A.total_distance / 1000).toFixed(2);

            atable.row.add({
                  DT_RowId: A.id,
                  ID: A.id,
                  date: ts,
                  type: A.type,
                  dist: dkm,
                  time: hhmmss(A.elapsed_time),
                  name: A.name,
                  strava_link: strava_link,
                  heatflask_link: heatflask_link
            }).draw(false).node();

            count++;
          }
        }
    });
  </script>
 </body>
</html>

