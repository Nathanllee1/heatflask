<!DOCTYPE html>
<html>
  <head>
    <title>Activities List</title>

    {% assets "basic_table_css" %}
    <link rel="stylesheet" href="{{ ASSET_URL }}" />
    {% endassets %}

    {% assets "basic_table_js" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}
  </head>

  <body>
  <h4>Activities list</h4>
  <div id="status">
    <span id="status_msg"></span>
    <span id="count"></span>
  </div>

  <table id='activities_list' class='display order-column compact' style="width:100%">
    <thead>
      <th>ID</th>
      <th>Link</th>
      <th>Date</th>
      <th>Type</th>
      <th>Dist</th>
      <th>Time</th>
      <th>Name</th>
    </thead>
    <tbody>
    </tbody>
  </table>



  <script>

    function td(text) {
      return "<td>" + text +"</td>";
    }


    jQuery(document).ready(function($) {
        let heatflask_button = img("{{ url_for('static',filename='Heat.png') }}"),
            USER_BASE_URL = "{{url_for('main',username=user.id)}}",
            count = 0,
            count_DOM_element = $("#count"),
            table_body = $('#activities_list tbody'),
            source = new EventSource("{{ url_for('activity_stream', username=user.id) }}");

        $("#status_msg").text("Retrieving Activity Index...");

        source.onmessage = function(event) {
          if (event.data == 'done') {
            source.close();
            $('#activities_list').DataTable({
                paging: false,
                scrollY: "80vh",
                scrollX: true,
                scrollCollapse: true,
                order: [[ 2, "desc" ]],
                select: false
            });
            $("#status").hide()

          } else {
            let A = JSON.parse(event.data);
            if ("id" in A) {
              count_DOM_element.text(count++);
              let heatflask_link = href(`${USER_BASE_URL}?id=${A.id}`, heatflask_button),
                  ts = A.beginTimestamp.slice(0,10),
                  dkm = +(A.total_distance / 1000).toFixed(2),
                  row = "<tr>" +
                     td(href(stravaActivityURL(A.id), A.id)) +
                     td(heatflask_link) +
                     td(ts) +
                     td(A.type) +
                     td(dkm) +
                     td(hhmmss(A.elapsed_time)) +
                     td(A.name) +
                     "</tr>";
              table_body.append(row);
            }
          }
        }
    });
  </script>
 </body>
</html>

